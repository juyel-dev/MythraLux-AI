<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NeuroLocal - Offline AI</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#111827">
    <meta name="description" content="Secure, offline AI running locally on your device via WebGPU.">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify/dist/purify.min.js"></script>

    <style>
        /* Custom Scrollbar */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #1f2937; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        
        /* Markdown Styles */
        .prose pre { background: #1f2937; padding: 10px; border-radius: 8px; overflow-x: auto; }
        .prose code { color: #93c5fd; font-family: monospace; }
        .prose p { margin-bottom: 0.5rem; }
        .prose ul { list-style-type: disc; padding-left: 1.5rem; }
        
        /* Loading Animation */
        .typing-dot { animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 h-full flex flex-col font-sans overflow-hidden">

    <header class="bg-gray-800 border-b border-gray-700 p-4 flex justify-between items-center shadow-md z-10">
        <div>
            <h1 class="text-xl font-bold bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">
                NeuroLocal
            </h1>
            <div class="flex items-center gap-2">
                <span id="gpu-indicator" class="w-2 h-2 rounded-full bg-red-500"></span>
                <p class="text-xs text-gray-400" id="model-status">Checking WebGPU...</p>
            </div>
        </div>
        <button id="settings-btn" class="p-2 text-gray-400 hover:text-white transition">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
        </button>
    </header>

    <div id="settings-panel" class="hidden absolute top-0 left-0 w-full h-full bg-gray-900/95 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-gray-800 p-6 rounded-xl w-full max-w-md border border-gray-700 shadow-2xl">
            <h2 class="text-lg font-bold mb-4">Configuration</h2>
            
            <div class="mb-4">
                <label class="block text-sm text-gray-400 mb-2">Select AI Model</label>
                <select id="model-select" class="w-full bg-gray-900 text-white p-3 rounded-lg border border-gray-600 focus:border-blue-500 outline-none">
                    <option value="Llama-3.2-1B-Instruct-q4f16_1-MLC">Llama 3.2 1B (Fast & Balanced)</option>
                    <option value="SmolLM2-135M-Instruct-q4f16_1-MLC">SmolLM2 135M (Super Fast/Tiny)</option>
                    <option value="gemma-2b-it-q4f16_1-MLC">Gemma 2B (Higher Quality)</option>
                    <option value="TinyLlama-1.1B-Chat-v1.0-q4f16_1-MLC">TinyLlama 1.1B (Legacy)</option>
                </select>
            </div>

            <div class="mb-4">
                <label class="block text-sm text-gray-400 mb-2">System Prompt</label>
                <textarea id="system-prompt" class="w-full bg-gray-900 p-2 rounded-lg border border-gray-600 text-sm h-20 resize-none">You are a helpful AI assistant. Answer concisely.</textarea>
            </div>

            <button id="load-btn" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg transition shadow-lg flex justify-center items-center gap-2">
                <span>Load Model</span>
            </button>

            <div id="progress-area" class="mt-4 hidden">
                <div class="flex justify-between text-xs text-gray-400 mb-1">
                    <span id="load-text">Downloading...</span>
                    <span id="load-percent">0%</span>
                </div>
                <div class="w-full bg-gray-700 rounded-full h-2">
                    <div id="progress-bar" class="bg-blue-500 h-2 rounded-full w-0 transition-all duration-300"></div>
                </div>
                <p class="text-xs text-gray-500 mt-2 text-center">First load takes time. Cached afterward.</p>
            </div>

            <button id="close-settings" class="mt-4 w-full text-gray-400 text-sm hover:text-white">Close</button>
        </div>
    </div>

    <main id="chat-box" class="flex-1 overflow-y-auto custom-scroll p-4 space-y-4 relative scroll-smooth">
        <div class="flex flex-col items-center justify-center h-full text-center space-y-4 opacity-50" id="welcome-screen">
            <svg class="w-16 h-16 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
            <p>Model not loaded. Open settings to begin.</p>
        </div>
    </main>

    <footer class="bg-gray-800 p-3 pb-safe">
        <div class="max-w-4xl mx-auto relative flex gap-2 items-end">
            <button id="reset-btn" class="p-3 text-gray-400 hover:text-red-400 bg-gray-700 rounded-lg" title="Clear Chat">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg>
            </button>
            
            <textarea id="user-input" rows="1" placeholder="Type a message..." class="flex-1 bg-gray-900 text-white p-3 rounded-lg border border-gray-700 focus:border-blue-500 outline-none resize-none max-h-32 scrollbar-hide" disabled></textarea>
            
            <button id="send-btn" class="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-700 disabled:text-gray-500 text-white p-3 rounded-lg font-bold transition flex items-center justify-center min-w-[50px]" disabled>
                <svg id="send-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                <div id="stop-icon" class="hidden w-4 h-4 bg-white rounded-sm"></div>
            </button>
        </div>
    </footer>

    <script type="module">
        import * as webllm from "https://esm.run/@mlc-ai/web-llm";

        // --- DOM Elements ---
        const els = {
            chatBox: document.getElementById('chat-box'),
            userInput: document.getElementById('user-input'),
            sendBtn: document.getElementById('send-btn'),
            loadBtn: document.getElementById('load-btn'),
            resetBtn: document.getElementById('reset-btn'),
            modelSelect: document.getElementById('model-select'),
            statusText: document.getElementById('model-status'),
            gpuIndicator: document.getElementById('gpu-indicator'),
            settingsPanel: document.getElementById('settings-panel'),
            settingsBtn: document.getElementById('settings-btn'),
            closeSettings: document.getElementById('close-settings'),
            progressBar: document.getElementById('progress-bar'),
            progressArea: document.getElementById('progress-area'),
            loadText: document.getElementById('load-text'),
            loadPercent: document.getElementById('load-percent'),
            welcomeScreen: document.getElementById('welcome-screen'),
            systemPrompt: document.getElementById('system-prompt'),
            sendIcon: document.getElementById('send-icon'),
            stopIcon: document.getElementById('stop-icon')
        };

        // --- State ---
        let engine = null;
        let messages = [];
        let isGenerating = false;
        let isModelLoaded = false;

        // --- Initialization ---
        async function checkGPU() {
            if (!navigator.gpu) {
                els.statusText.innerText = "WebGPU not supported on this browser.";
                els.gpuIndicator.className = "w-2 h-2 rounded-full bg-red-500";
                return false;
            }
            try {
                const adapter = await navigator.gpu.requestAdapter();
                if (!adapter) throw new Error("No GPU adapter found");
                els.statusText.innerText = "GPU Detected - Ready to Load";
                els.gpuIndicator.className = "w-2 h-2 rounded-full bg-green-500 shadow-[0_0_10px_rgba(34,197,94,0.5)]";
                return true;
            } catch (e) {
                els.statusText.innerText = "GPU Access Error";
                return false;
            }
        }
        
        checkGPU();

        // --- Event Listeners ---
        els.settingsBtn.onclick = () => els.settingsPanel.classList.remove('hidden');
        els.closeSettings.onclick = () => els.settingsPanel.classList.add('hidden');
        
        // Auto-resize textarea
        els.userInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });

        els.loadBtn.onclick = async () => {
            const modelId = els.modelSelect.value;
            els.loadBtn.disabled = true;
            els.progressArea.classList.remove('hidden');
            
            try {
                els.loadBtn.innerHTML = `<span class="animate-spin">â†»</span> Loading...`;
                
                // Initialize Engine
                engine = await webllm.CreateMLCEngine(modelId, {
                    initProgressCallback: (report) => {
                        els.loadText.innerText = report.text.length > 30 ? "Downloading weights..." : report.text;
                        // Attempt to extract percentage nicely
                        const match = report.text.match(/\[(\d+)\/(\d+)\]/) || report.text.match(/(\d+)%/);
                        let percent = 0;
                        if (match && match[2]) {
                            percent = (parseInt(match[1]) / parseInt(match[2])) * 100;
                        } else if (match && match[1]) {
                            percent = parseInt(match[1]);
                        } else if (report.progress) {
                            percent = report.progress * 100; 
                        }
                        
                        // Fake visual progress if regex fails but text changes
                        if(percent === 0 && report.text.includes("Fetch")) percent = 10;
                        
                        els.progressBar.style.width = `${percent}%`;
                        els.loadPercent.innerText = `${Math.round(percent)}%`;
                    }
                });

                isModelLoaded = true;
                els.statusText.innerText = `${modelId.split('-')[0]} Ready`;
                els.loadBtn.innerText = "Model Loaded Successfully";
                els.userInput.disabled = false;
                els.sendBtn.disabled = false;
                els.welcomeScreen.classList.add('hidden');
                setTimeout(() => els.settingsPanel.classList.add('hidden'), 500);

            } catch (err) {
                console.error(err);
                els.statusText.innerText = "Error Loading Model";
                els.loadBtn.innerText = "Retry Load";
                els.loadBtn.disabled = false;
                alert("Failed to load: " + err.message);
            }
        };

        els.sendBtn.onclick = async () => {
            if (isGenerating) {
                if (engine) engine.interruptGenerate(); // Stop if already generating
                isGenerating = false;
                toggleSendButton(false);
                return;
            }

            const text = els.userInput.value.trim();
            if (!text) return;

            // UI Updates
            appendMessage('user', text);
            els.userInput.value = '';
            els.userInput.style.height = 'auto';
            
            // Context Management
            if (messages.length === 0) {
                messages.push({ role: "system", content: els.systemPrompt.value });
            }
            messages.push({ role: "user", content: text });

            // AI Response Placeholder
            const aiMsgDiv = appendMessage('assistant', '');
            const contentDiv = aiMsgDiv.querySelector('.msg-content');
            const loadingIndicator = document.createElement('div');
            loadingIndicator.innerHTML = '<div class="flex gap-1 mt-1"><div class="w-2 h-2 bg-gray-500 rounded-full typing-dot"></div><div class="w-2 h-2 bg-gray-500 rounded-full typing-dot"></div><div class="w-2 h-2 bg-gray-500 rounded-full typing-dot"></div></div>';
            contentDiv.appendChild(loadingIndicator);

            isGenerating = true;
            toggleSendButton(true);

            let fullResponse = "";
            let curMessage = "";

            try {
                const chunks = await engine.chat.completions.create({
                    messages: messages,
                    temperature: 0.7,
                    stream: true,
                });

                // Remove loader once streaming starts
                if(contentDiv.contains(loadingIndicator)) contentDiv.removeChild(loadingIndicator);

                for await (const chunk of chunks) {
                    if(!isGenerating) break; 
                    const delta = chunk.choices[0]?.delta?.content || "";
                    fullResponse += delta;
                    
                    // Throttle Markdown rendering for performance
                    contentDiv.innerHTML = DOMPurify.sanitize(marked.parse(fullResponse));
                    
                    // Auto scroll
                    els.chatBox.scrollTop = els.chatBox.scrollHeight;
                }
                
                messages.push({ role: "assistant", content: fullResponse });

            } catch (err) {
                contentDiv.innerHTML += `<br><span class="text-red-400 text-xs">Error: ${err.message}</span>`;
            } finally {
                isGenerating = false;
                toggleSendButton(false);
            }
        };

        els.resetBtn.onclick = () => {
            messages = [];
            els.chatBox.innerHTML = '';
            els.chatBox.appendChild(els.welcomeScreen);
            if(isModelLoaded) els.welcomeScreen.classList.add('hidden');
        };

        // --- Helpers ---
        function appendMessage(role, text) {
            const div = document.createElement('div');
            const isUser = role === 'user';
            
            div.className = `flex w-full ${isUser ? 'justify-end' : 'justify-start'}`;
            
            const bubble = document.createElement('div');
            bubble.className = `max-w-[85%] rounded-2xl p-3 shadow-sm ${
                isUser 
                ? 'bg-blue-600 text-white rounded-br-none' 
                : 'bg-gray-800 text-gray-100 rounded-bl-none prose prose-invert text-sm border border-gray-700'
            }`;
            
            const content = document.createElement('div');
            content.className = 'msg-content break-words';
            
            if (text) {
                content.innerHTML = isUser ? text.replace(/\n/g, '<br>') : DOMPurify.sanitize(marked.parse(text));
            }
            
            bubble.appendChild(content);
            div.appendChild(bubble);
            els.chatBox.appendChild(div);
            els.chatBox.scrollTop = els.chatBox.scrollHeight;
            return div;
        }

        function toggleSendButton(generating) {
            if (generating) {
                els.sendIcon.classList.add('hidden');
                els.stopIcon.classList.remove('hidden');
                els.sendBtn.classList.replace('bg-blue-600', 'bg-red-600');
                els.sendBtn.classList.replace('hover:bg-blue-700', 'hover:bg-red-700');
            } else {
                els.sendIcon.classList.remove('hidden');
                els.stopIcon.classList.add('hidden');
                els.sendBtn.classList.replace('bg-red-600', 'bg-blue-600');
                els.sendBtn.classList.replace('hover:bg-red-700', 'hover:bg-blue-700');
            }
        }

        // --- Service Worker Reg ---
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js').then(() => console.log('SW Registered'));
        }
    </script>
</body>
</html>
