<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NeuroLocal v2.0</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify/dist/purify.min.js"></script>
    <style>
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }
        .prose pre { background: #111827; padding: 12px; border-radius: 8px; overflow-x: auto; color: #93c5fd; font-size: 0.85rem; margin: 8px 0; }
        .prose code { background: #374151; padding: 2px 4px; border-radius: 4px; color: #fbbf24; }
        .typing-dot { animation: typing 1.4s infinite; }
        @keyframes typing { 0%, 100% { opacity: 0; } 50% { opacity: 1; } }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 flex flex-col h-screen overflow-hidden font-sans">

    <header class="p-4 border-b border-gray-800 flex justify-between items-center bg-gray-900/50 backdrop-blur-md">
        <div>
            <h1 class="text-xl font-black tracking-tighter text-blue-500">NEURO<span class="text-white">LOCAL</span></h1>
            <div id="status-bar" class="text-[10px] uppercase tracking-widest text-gray-500 flex items-center gap-1">
                <span id="indicator" class="w-1.5 h-1.5 rounded-full bg-red-600"></span>
                <span id="status-text">Engine Offline</span>
            </div>
        </div>
        <button id="config-btn" class="bg-gray-800 p-2 rounded-full hover:bg-gray-700 transition">‚öôÔ∏è</button>
    </header>

    <main id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-6 custom-scroll">
        <div id="welcome-msg" class="h-full flex flex-col items-center justify-center text-center space-y-4 opacity-40 px-10">
            <div class="w-16 h-16 bg-blue-600/20 rounded-full flex items-center justify-center text-3xl">ü§ñ</div>
            <p class="text-sm">‡¶∏‡¶¨‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶°‡¶ø‡¶≠‡¶æ‡¶á‡¶∏‡ßá‡¶á ‡¶™‡ßç‡¶∞‡¶∏‡ßá‡¶∏ ‡¶π‡¶ö‡ßç‡¶õ‡ßá‡•§ ‡¶™‡ßç‡¶∞‡¶æ‡¶á‡¶≠‡ßá‡¶∏‡¶ø ‡ßß‡ß¶‡ß¶% ‡¶∏‡ßÅ‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§‡•§ ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡¶§‡ßá ‡¶Æ‡¶°‡ßá‡¶≤ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p>
        </div>
    </main>

    <div id="modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-gray-800 w-full max-w-md p-6 rounded-2xl border border-gray-700 shadow-2xl">
            <h2 class="text-xl font-bold mb-4">Model Settings</h2>
            <select id="model-select" class="w-full bg-gray-900 border border-gray-700 p-3 rounded-xl mb-4 outline-none focus:border-blue-500">
                <option value="Llama-3.2-1B-Instruct-q4f16_1-MLC">Llama 3.2 1B (‡¶∏‡ßÅ‡¶™‡¶æ‡¶∞ ‡¶´‡¶æ‡¶∏‡ßç‡¶ü)</option>
                <option value="SmolLM2-135M-Instruct-q4f16_1-MLC">SmolLM2 135M (‡¶∏‡¶¨‡¶ö‡ßá‡¶Ø‡¶º‡ßá ‡¶π‡¶æ‡¶≤‡¶ï‡¶æ)</option>
                <option value="gemma-2b-it-q4f16_1-MLC">Gemma 2B (‡¶¨‡ßá‡¶∂‡¶ø ‡¶∏‡ßç‡¶Æ‡¶æ‡¶∞‡ßç‡¶ü)</option>
            </select>
            <div id="progress-container" class="hidden mb-4">
                <div class="flex justify-between text-xs mb-1"><span id="p-label">Downloading...</span><span id="p-percent">0%</span></div>
                <div class="w-full bg-gray-700 h-1.5 rounded-full overflow-hidden"><div id="p-bar" class="bg-blue-500 h-full w-0 transition-all"></div></div>
            </div>
            <button id="load-btn" class="w-full bg-blue-600 py-3 rounded-xl font-bold hover:bg-blue-500 transition disabled:opacity-50">Load Engine</button>
            <button id="close-modal" class="w-full mt-2 text-gray-500 text-sm">Close</button>
        </div>
    </div>

    <footer class="p-4 bg-gray-900 border-t border-gray-800">
        <div class="max-w-3xl mx-auto flex items-end gap-2">
            <textarea id="user-input" rows="1" placeholder="‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..." class="flex-1 bg-gray-800 border border-gray-700 p-3 rounded-2xl outline-none focus:border-blue-500 resize-none max-h-40 disabled:opacity-50" disabled></textarea>
            <button id="send-btn" class="bg-blue-600 p-4 rounded-2xl hover:bg-blue-500 transition disabled:opacity-30 flex items-center justify-center" disabled>
                <svg id="send-svg" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
                <div id="stop-svg" class="hidden w-3 h-3 bg-white rounded-sm"></div>
            </button>
        </div>
    </footer>

    <script type="module">
        import * as webllm from "https://esm.run/@mlc-ai/web-llm";

        // --- State Management ---
        let engine = null;
        let messages = []; // Chat History
        let isProcessing = false;
        let selectedModel = "";

        const els = {
            chat: document.getElementById('chat-container'),
            input: document.getElementById('user-input'),
            send: document.getElementById('send-btn'),
            load: document.getElementById('load-btn'),
            modal: document.getElementById('modal'),
            config: document.getElementById('config-btn'),
            status: document.getElementById('status-text'),
            indicator: document.getElementById('indicator'),
            progressBar: document.getElementById('p-bar'),
            progressLabel: document.getElementById('p-label'),
            progressPercent: document.getElementById('p-percent'),
            pContainer: document.getElementById('progress-container')
        };

        // --- Core Functions ---
        async function loadModel() {
            selectedModel = document.getElementById('model-select').value;
            els.load.disabled = true;
            els.pContainer.classList.remove('hidden');

            try {
                // Garbage collection of old engine if exists
                if(engine) {
                    await engine.unload();
                    engine = null;
                }

                engine = await webllm.CreateMLCEngine(selectedModel, {
                    initProgressCallback: (p) => {
                        const percent = Math.round(p.progress * 100);
                        els.progressBar.style.width = percent + '%';
                        els.progressPercent.innerText = percent + '%';
                        els.progressLabel.innerText = p.text.split(']')[1] || "Initializing...";
                    }
                });

                els.status.innerText = "Engine Ready: " + selectedModel.split('-')[0];
                els.indicator.className = "w-1.5 h-1.5 rounded-full bg-green-500 shadow-[0_0_8px_#10b981]";
                els.input.disabled = false;
                els.send.disabled = false;
                els.modal.classList.add('hidden');
                document.getElementById('welcome-msg').classList.add('hidden');
            } catch (e) {
                alert("Error: " + e.message);
                els.load.disabled = false;
            }
        }

        async function sendMessage() {
            if (isProcessing) {
                engine.interruptGenerate();
                return;
            }

            const prompt = els.input.value.trim();
            if (!prompt) return;

            // UI Update
            isProcessing = true;
            toggleLoadingUI(true);
            appendBubble('user', prompt);
            els.input.value = '';
            els.input.style.height = 'auto';

            // History Update
            messages.push({ role: "user", content: prompt });

            try {
                const aiBubble = appendBubble('assistant', '');
                const contentDiv = aiBubble.querySelector('.content');
                let fullResponse = "";

                const chunks = await engine.chat.completions.create({
                    messages: messages,
                    stream: true,
                    temperature: 0.7
                });

                for await (const chunk of chunks) {
                    const content = chunk.choices[0]?.delta?.content || "";
                    fullResponse += content;
                    contentDiv.innerHTML = DOMPurify.sanitize(marked.parse(fullResponse));
                    els.chat.scrollTop = els.chat.scrollHeight;
                }

                messages.push({ role: "assistant", content: fullResponse });

            } catch (err) {
                console.error(err);
                if(err.message.includes("disposed")) {
                    appendBubble('assistant', '‚ö†Ô∏è ‡¶è‡¶∞‡¶∞: ‡¶á‡¶û‡ßç‡¶ú‡¶ø‡¶®‡¶ü‡¶ø ‡¶Æ‡ßá‡¶Æ‡ßã‡¶∞‡¶ø ‡¶•‡ßá‡¶ï‡ßá ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶ó‡ßá‡¶õ‡ßá‡•§ ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶Æ‡¶°‡ßá‡¶≤‡¶ü‡¶ø ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
                } else {
                    appendBubble('assistant', '‚ö†Ô∏è ‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶è‡¶ï‡¶ü‡¶æ ‡¶≠‡ßÅ‡¶≤ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§ ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
                }
            } finally {
                isProcessing = false;
                toggleLoadingUI(false);
            }
        }

        // --- UI Helpers ---
        function appendBubble(role, text) {
            const div = document.createElement('div');
            div.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'} animate-in slide-in-from-bottom-2 duration-300`;
            div.innerHTML = `
                <div class="max-w-[85%] p-3 rounded-2xl ${role === 'user' ? 'bg-blue-600 text-white rounded-br-none' : 'bg-gray-800 text-gray-200 rounded-bl-none border border-gray-700 shadow-lg'}">
                    <div class="text-[10px] font-bold uppercase mb-1 opacity-50">${role}</div>
                    <div class="content prose prose-invert max-w-none text-sm leading-relaxed">${text}</div>
                </div>
            `;
            els.chat.appendChild(div);
            els.chat.scrollTop = els.chat.scrollHeight;
            return div;
        }

        function toggleLoadingUI(loading) {
            if (loading) {
                document.getElementById('send-svg').classList.add('hidden');
                document.getElementById('stop-svg').classList.remove('hidden');
                els.send.classList.replace('bg-blue-600', 'bg-red-600');
            } else {
                document.getElementById('send-svg').classList.remove('hidden');
                document.getElementById('stop-svg').classList.add('hidden');
                els.send.classList.replace('bg-red-600', 'bg-blue-600');
            }
        }

        // --- Listeners ---
        els.load.onclick = loadModel;
        els.send.onclick = sendMessage;
        els.config.onclick = () => els.modal.classList.toggle('hidden');
        els.close_modal = document.getElementById('close-modal').onclick = () => els.modal.classList.add('hidden');
        
        els.input.oninput = function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        };

        els.input.onkeydown = (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        };

        // Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js');
        }
    </script>
</body>
</html>
